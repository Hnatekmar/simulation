!function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=5)}([function(t,e){t.exports=require("p2")},function(t,e){t.exports=require("ces")},function(t,e){t.exports=require("pixi.js")},function(t,e){t.exports=require("chance")},function(t,e){t.exports=require("lodash")},function(t,e,n){var o=new(0,n(6).JSDOM)("<html><body></body></html>");global.document=o.window.document,global.window=o.window,global.navigator={userAgent:"node.js"};var i=new n(7),s=n(11).default,r=n(9),a=n(10),h=new r.Neat(37,6,null,{popsize:8,mutation:r.methods.mutation.ALL,mutationRate:.25,network:new r.architect.Random(37,128,6)});if(a.existsSync("population.json")){var c=a.readFileSync("population.json");h.import(JSON.parse(c))}else a.writeFileSync("population.json",JSON.stringify(h.export()));var l=new s(null,60);var d=i(function(){for(var t in h.population)l.evalGenome(1/30,h.population[t])});console.log(d),console.log(d.milliseconds()+" ms")},function(t,e){t.exports=require("jsdom")},function(t,e){t.exports=require("nodemark")},function(t,e){t.exports=require("assert")},function(t,e){t.exports=require("neataptic")},function(t,e){t.exports=require("fs")},function(t,e,n){"use strict";n.r(e);var o=n(2),i=n(1),s=i.System.extend({setCanvas:function(t){void 0===this.renderer&&(this.renderer=new o.Application({view:t,antialias:!0,width:800,height:800}),this.canvas=t,this.renderer.ticker.stop())},addedToWorld:function(t){var e=this;t.entityAdded("graphics").add(function(t){e.renderer.stage.addChild(t.getComponent("graphics").container)}),t.entityRemoved("graphics").add(function(t){e.renderer.stage.removeChild(t.getComponent("graphics").container)})},update:function(t){this.draw&&this.renderer.ticker.update()}}),r=n(0),a=i.System.extend({addedToWorld:function(t){var e=this;this._super(t),this.p2World=new r.World({gravity:[0,0]}),t.entityAdded("physics").add(function(t){var n=t.getComponent("physics");n.world=e.p2World,e.p2World.addBody(n.body)}),t.entityRemoved("physics").add(function(t){e.p2World.removeBody(t.getComponent("physics").body)})},update:function(t){this.p2World.step(1/30,t,5),this.world.getEntities("graphics","physics").forEach(function(t){var e=t.getComponent("physics").body,n=e.position,o=t.getComponent("graphics").container;o.position.set(n[0],n[1]),o.rotation=e.angle})}});function h(t){for(var e=-1,n=-1,o=0;o<t.length;o++)t[o]>n&&(n=t[o],e=o);return e}var c=i.System.extend({update:function(t){var e=this;this.world.getEntities("car").forEach(function(t){var n=t.getComponent("car"),o=n.chassis.getComponent("physics").body;if(void 0===o.callbackInitialized&&(o.world.on("beginContact",function(t){var e=t.bodyA,i=t.bodyB;o.sleepState!==r.Body.SLEEPING&&(n.fitness-=5e4),e.id!==o.id&&i.id!==o.id||(o.allowSleep=!0,o.force=[0,0],o.sleep())}),o.callbackInitialized=!0),void 0===e.input){e.input=[];for(var i=0;i<=n.sensors.length;i++)e.input.push(0);n.backWheel.setBrakeForce(0),n.frontWheel.setBrakeForce(0),n.frontWheel.setSideFriction(8e3),n.backWheel.setSideFriction(6e3)}for(var s=0;s<n.sensors.length;s++)n.sensors[s].cast(o.position,[o.id],o.angle),(n.sensors[s].shortest.distance===1/0||n.sensors[s].shortest.distance>800)&&(n.sensors[s].shortest.distance=800),n.sensors[s].shortest.distance/=800,e.input[s]=n.sensors[s].shortest.distance;e.input[n.sensors.length-1]=o.angle;var a=Math.sqrt(r.vec2.squaredLength(o.velocity));if(0===a&&0!==n.fitness&&(o.allowSleep=!0,o.force=[0,0],o.sleep()),o.sleepState!==r.Body.SLEEPING){for(var c=n.genome.activate(e.input),l=isNaN(a),d=0;d<c.length;d++)if(l||isNaN(c[d]))return c[d]=0,n.fitness=-9e6,o.allowSleep=!0,o.force=[0,0],void o.sleep();var u=h(c.slice(0,3)),p=h(c.slice(4,6)),f=0;0===p?(f=-1,n.fitness+=a):1===p?(f=.15,n.fitness+=.5*a):2===p&&(0===a&&(o.allowSleep=!0,o.force=[0,0],o.sleep()),f=0,n.fitness-=100,n.frontWheel.setBrakeForce(1e4)),0===u?n.frontWheel.steerValue>5/6*Math.PI&&(n.frontWheel.steerValue-=Math.PI/180*10):1===u&&n.frontWheel.steerValue<Math.PI/6&&(n.frontWheel.steerValue+=Math.PI/180*10),n.backWheel.engineForce=7*f*9e3}})}}),l=i.Component.extend({name:"graphics",init:function(t){var e=this;this.container=new o.Container,t.forEach(function(t){return e.container.addChild(t)}),this.container.pivot.set(this.container.width/2,this.container.height/2)}}),d=i.Component.extend({name:"physics",init:function(t){this.body=t}}),u=i.Component.extend({name:"car",force:0,init:function(t,e,n,o,i){this.genome=e,this.chassis=t,this.car=n,this.fitness=0,this.frontWheel=o,this.backWheel=i},getAngle:function(t,e){return e<t.angleFrom&&(e=t.angleFrom),e>t.angleTo&&(e=t.angleTo),e},steer:function(t){var e=this;this.wheels.forEach(function(n){n.angle=e.getAngle(n,t)})}}),p=n(4);function f(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var y=function(){function t(e,n,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.endPoint=e,this.world=o,this.shortest=null,this.endPoint[0]*=800,this.endPoint[1]*=800,this.ignoredIDs=new Set(n);var i=this;this.result=new r.RaycastResult,this.ray=new r.Ray({mode:r.Ray.ALL,from:i.origin,to:i.endPoint,callback:function(t){if(!i.ignoredIDs.has(t.body.id)){var e=t.getHitDistance(i.ray);e<i.shortest.distance&&(i.shortest.distance=e,i.shortest.body=t.body)}}})}return function(t,e,n){e&&f(t.prototype,e),n&&f(t,n)}(t,[{key:"cast",value:function(t,e){var n=Math.cos(e),o=Math.sin(e),i=[this.endPoint[0]*n-this.endPoint[1]*o,this.endPoint[0]*o+this.endPoint[1]*n];this.ray.from=t,this.ray.to=[t[0]+i[0],t[1]+i[1]],this.calculateShortest()}},{key:"calculateShortest",value:function(){this.shortest={distance:1/0},this.ray.update(),this.world.raycast(this.result,this.ray),this.result.reset()}}]),t}();var w=function(t,e,n,s,a){var h=new i.Entity;h.addComponent(new l([function(t,e,n,i,s){var r=new o.Graphics;return r.beginFill(s,1),r.drawRect(t,e,n,i),r.position.set(t,e),r}(0,0,n,s,65280)]));var c=new r.Body({mass:0,position:[t,e]});return c.addShape(new r.Box({width:n,height:s})),h.addComponent(new d(c)),a.addEntity(h),h};function v(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var g=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),n(8)(e instanceof Array),this.bodies=e,this.bodies.forEach(function(t){t.oldOrigin=t.body.position.slice(0)})}return function(t,e,n){e&&v(t.prototype,e),n&&v(t,n)}(t,[{key:"move",value:function(t,e){this.bodies.forEach(function(n){n.body.position[0]+=t,n.body.position[1]+=e})}},{key:"moveAbsolute",value:function(t,e){this.bodies.forEach(function(t){t.body.position=t.oldOrigin.slice(0)}),this.move(t,e)}}]),t}(),m=function(t,e,n,o){var i=o.map(function(t){return t.getComponent("physics")});return new g(i)},b=n(3),C=n.n(b);var P=i.System.extend({setWorld:function(t){var e=this;this.world=t,this.rng=new C.a("RNG0,0"),this.position=[0,0],this.parts={"-":{group:m(0,0,this.world,[w(0,250,8e3,20,this.world),w(0,550,8e3,20,this.world)]),possibleParts:{left:["Cross","T"],right:["Cross","T"]}},I:{group:m(0,0,this.world,[w(250,0,20,8e3,this.world),w(550,0,20,8e3,this.world)]),possibleParts:{up:["Cross","I"],down:["Cross","T","I"]}},T:{group:m(0,0,this.world,[w(250,700,20,400,this.world),w(550,700,20,400,this.world),w(125,500,250,20,this.world),w(675,500,250,20,this.world),w(400,250,800,20,this.world)]),possibleParts:{down:["Cross","I"],up:["Cross","I"],left:["Cross","T"],right:["Cross","T"]}},Cross:{group:m(0,0,this.world,[w(675,500,250,20,this.world),w(125,500,250,20,this.world),w(675,250,250,20,this.world),w(125,250,250,20,this.world),w(250,50,20,400,this.world),w(550,50,20,400,this.world),w(250,700,20,400,this.world),w(550,700,20,400,this.world)]),possibleParts:{up:["Cross","I"],down:["Cross","T","I"],left:["Cross","T"],right:["Cross","T"]}},Box:{group:m(0,0,this.world,[w(400,0,800,20,this.world),w(0,400,20,800,this.world),w(800,400,20,800,this.world),w(400,800,800,20,this.world)]),possibleParts:{}}},Object.keys(this.parts).forEach(function(t){"Box"!==t&&e.parts[t].group.moveAbsolute(5e4*Math.sin(Math.random()),5e4*Math.cos(Math.random()))})},reset:function(){this.rng=new C.a("RNG0,0"),this.position=[0,0],this.currentPart.group.moveAbsolute(5e4*Math.sin(Math.random()),5e4*Math.cos(Math.random())),this.currentPart=this.parts.Box,this.currentPart.group.moveAbsolute(0,0)},setCar:function(t){this.car=t},getCarPosition:function(){return null!=this.car?this.car.getComponent("physics").body.position:null},swapNextRoadPart:function(t){if(void 0!==this.currentPart){var e=this.currentPart.possibleParts[t];0!==e.length&&("up"===t&&(this.position[1]+=1),"down"===t&&(this.position[1]-=1),"left"===t&&(this.position[0]-=1),"right"===t&&(this.position[0]+=1),this.currentPart.group.moveAbsolute(5e4,5e4),this.rng=new C.a("RNG"+this.position[0]+","+this.position[1]),0===this.position[0]&&0===this.position[1]?this.currentPart=this.parts.Box:this.currentPart=this.parts[this.rng.pickone(e)],this.currentPart.group.moveAbsolute(0,0),this.moveCarBackToScreen(t))}},moveCarBackToScreen:function(t){var e=this.car.getComponent("physics").body;this.car.getComponent("car").fitness+=500;var n=[0,0];"up"===t?n=[e.position[0],0]:"down"===t?n=[e.position[0],800]:"left"===t?n=[800,e.position[1]]:"right"===t&&(n=[0,e.position[1]]),e.position=n},update:function(t){void 0===this.currentPart&&(this.currentPart=this.parts.Box);var e=this.getCarPosition();if(null!==e){var n=function(t,e,n,o){return t>=n?"right":e>=o?"up":t<=0?"left":e<=0?"down":"onScreen"}(e[0],e[1],800,800);"onScreen"!==n&&this.swapNextRoadPart(n)}}});function S(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}n.d(e,"default",function(){return k});var x=n(1);var k=function(){function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.time=n,this.canvasElement=e}return function(t,e,n){e&&S(t.prototype,e),n&&S(t,n)}(t,[{key:"init",value:function(t){void 0===this.world?(this.world=new x.World,null!==t&&(this.renderer=new s,this.renderer.setCanvas(t),this.renderer.draw=!0,this.world.addSystem(this.renderer)),this.physicsSystem=new a,this.world.addSystem(this.physicsSystem),this.world.addSystem(new c),this.car=function(t,e,n,s){var a=new i.Entity;if(void 0!==o.loader.resources["./static/chassis.png"]){var h=new l([new o.Sprite(o.loader.resources["./static/chassis.png"].texture)]);a.addComponent(h)}var c=new r.Body({mass:2e3,position:[t,e],allowSleep:!1});c.addShape(new r.Box({width:100,height:200})),a.addComponent(new d(c));var f=new r.TopDownVehicle(c),w=f.addWheel({localPosition:[0,100]}),v=f.addWheel({localPosition:[0,-100]});a.addComponent(new u(a,s,f,w,v)),n.addEntity(a);var g=a.getComponent("car"),m=a.getComponent("physics").world;return f.addToWorld(m),g.sensors=p.range(0,360,10).map(function(t){return new y([Math.cos(t*(Math.PI/180)),Math.sin(t*(Math.PI/180))],[c.id],m)}),a}(400,400,this.world,this.genome),this.roadDirector=new P,this.roadDirector.setWorld(this.world),this.roadDirector.setCar(this.car),this.world.addSystem(this.roadDirector)):this.car.getComponent("car").genome=this.genome,this.lastDt=0}},{key:"evaluate",value:function(t){this.destroy(),this.genome=t,this.init(this.canvasElement),this.acc=0,this.lastDt=null;var e=this;return new Promise(function(t){e.onFinish=t})}},{key:"evalGenome",value:function(t,e){for(this.evaluate(e);this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==r.Body.SLEEPING;)this.update(t)}},{key:"update",value:function(t){null===this.lastDt&&(this.lastDt=t),this.acc+=t;var e=this.car.getComponent("car").fitness;this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==r.Body.SLEEPING?this.world.update(t):this.onFinish(e)}},{key:"destroy",value:function(){if(void 0!==this.world){this.car.getComponent("car").fitness=0;var t=this.car.getComponent("physics").body;!function(t,e){function n(t){return isNaN(t)?e:t}var o=Object.keys(t);for(var i in o)if("number"==typeof t[o[i]]&&isNaN(t[o[i]]))t[o[i]]=e;else if(null!==t[o[i]]&&t[o[i]].constructor===Float32Array)for(var s=0;s<t[o[i]].length;s++)t[o[i]][s]=n(t[o[i]][s])}(t,0),t.allowSleep=!1,t.sleepState===r.Body.SLEEPING&&t.wakeUp(),t.setZeroForce(),t.position=[this.position[0],this.position[1]],t.angularVelocity=0,t.velocity=[0,0],t.angle=0,this.roadDirector.reset()}else this.position=[400,400],this.velocity=[0,0]}}]),t}()}]);