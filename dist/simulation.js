!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.simulation=e():t.simulation=e()}(global,function(){return function(t){var e={};function i(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(o,n,function(e){return t[e]}.bind(null,n));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=5)}([function(t,e){t.exports=require("p2")},function(t,e){t.exports=require("ces")},function(t,e){t.exports=require("pixi.js")},function(t,e){t.exports=require("chance")},function(t,e){t.exports=require("assert")},function(t,e,i){"use strict";i.r(e);var o=i(2),n=i(1),s=n.System.extend({setCanvas:function(t){void 0===this.renderer&&(this.renderer=new o.Application({view:t,antialias:!0,width:800,height:800}),this.canvas=t,this.renderer.ticker.stop())},addedToWorld:function(t){var e=this;t.entityAdded("graphics").add(function(t){e.renderer.stage.addChild(t.getComponent("graphics").container)}),t.entityRemoved("graphics").add(function(t){e.renderer.stage.removeChild(t.getComponent("graphics").container)})},update:function(t){this.draw&&this.renderer.ticker.update()}}),r=i(0),a=n.System.extend({addedToWorld:function(t){var e=this;this._super(t),this.p2World=new r.World({gravity:[0,0]}),t.entityAdded("physics").add(function(t){var i=t.getComponent("physics");i.world=e.p2World,e.p2World.addBody(i.body)}),t.entityRemoved("physics").add(function(t){e.p2World.removeBody(t.getComponent("physics").body)})},update:function(t){this.p2World.step(.016,t,5),this.world.getEntities("graphics","physics").forEach(function(t){var e=t.getComponent("physics").body,i=e.position,o=t.getComponent("graphics").container;o.position.set(i[0],i[1]),o.rotation=e.angle})}});function c(t){for(var e=-1,i=-1,o=0;o<t.length;o++)t[o]>i&&(i=t[o],e=o);return e}var h=n.System.extend({acc:0,updateSensors:function(t,e,i,o){for(var n=0;n<t.sensors.length;n++)t.sensors[n].cast(o.position,o.angle),(t.sensors[n].shortest.distance===1/0||t.sensors[n].shortest.distance>800)&&(t.sensors[n].shortest.distance=800),i&&(e.moveTo(t.sensors[n].ray.from[0],t.sensors[n].ray.from[1]),e.lineTo(t.sensors[n].ray.from[0]+t.sensors[n].ray.direction[0]*t.sensors[n].shortest.distance,t.sensors[n].ray.from[1]+t.sensors[n].ray.direction[1]*t.sensors[n].shortest.distance)),t.sensors[n].shortest.distance/=800,this.input[n]=t.sensors[n].shortest.distance},update:function(t){var e=this;this.acc=0,this.world.getEntities("car").forEach(function(i){var n,s=i.getComponent("car"),a=i.getComponent("graphics"),h=s.chassis.getComponent("physics").body;if(void 0===h.callbackInitialized&&(h.world.on("beginContact",function(t){var e=t.bodyA,i=t.bodyB,o=Math.sqrt(r.vec2.squaredLength(h.velocity));(e.id===h.id||i.id===h.id&&o>1)&&(h.force=[0,0],h.allowSleep=!0,h.force=[0,0],h.sleep())}),h.callbackInitialized=!0),void 0===e.input){e.input=[];for(var u=0;u<s.sensors.length+2;u++)e.input.push(0);s.backWheel.setBrakeForce(0),s.frontWheel.setBrakeForce(0),s.frontWheel.setSideFriction(8e3),s.backWheel.setSideFriction(6e3)}if(void 0!==a&&(void 0===s.graphics?(n=new o.Graphics,a.container.parent.addChild(n),s.graphics=n):n=s.graphics,n.clear(),n.lineStyle(5,16777215,255)),e.updateSensors(s,n,void 0!==a,h),h.sleepState!==r.Body.SLEEPING){var d,p=Math.sqrt(r.vec2.squaredLength(h.velocity));s.options.inputVelocity&&e.input.push(p/42),s.options.inputWheel&&e.input.push((d=s.frontWheel.steerValue,(d%=2*Math.PI)<0&&(d+=2*Math.PI),d));for(var l=s.genome.activate(e.input),f=isNaN(p),v=0;v<l.length;v++)if(f||isNaN(l[v]))return l[v]=0,s.fitness=-9e6,h.allowSleep=!0,h.force=[0,0],void h.sleep();var g=void 0!==s.options.holdWheel?1:0,y=c(l.slice(0,2+g));0===y?s.frontWheel.steerValue<Math.PI/180*15&&(s.frontWheel.steerValue+=Math.PI/180*15*t):1===y&&s.frontWheel.steerValue>=-Math.PI/180*15&&(s.frontWheel.steerValue-=Math.PI/180*15*t);var m=c(l.slice(2+g,4+g));0===m&&(m=-1),s.backWheel.engineForce=-1*m*9e3}})}}),u=n.Component.extend({name:"graphics",init:function(t){var e=this;this.container=new o.Container,t.forEach(function(t){return e.container.addChild(t)}),this.container.pivot.set(this.container.width/2,this.container.height/2)}}),d=n.Component.extend({name:"physics",init:function(t){this.body=t}}),p=n.Component.extend({name:"car",force:0,init:function(t,e,i,o,n){this.genome=e,this.chassis=t,this.car=i,this.fitness=0,this.frontWheel=o,this.backWheel=n},getAngle:function(t,e){return e<t.angleFrom&&(e=t.angleFrom),e>t.angleTo&&(e=t.angleTo),e},steer:function(t){var e=this;this.wheels.forEach(function(i){i.angle=e.getAngle(i,t)})}});function l(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var f=function(){function t(e,i,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.endPoint=e,this.world=o,this.shortest=null,this.endPoint[0]*=800,this.endPoint[1]*=800,this.ignoredIDs=new Set(i);var n=this;this.result=new r.RaycastResult,this.ray=new r.Ray({mode:r.Ray.ALL,from:n.origin,to:n.endPoint,callback:function(t){if(!n.ignoredIDs.has(t.body.id)){var e=t.getHitDistance(n.ray);e<n.shortest.distance&&(n.shortest.distance=e,n.shortest.body=t.body)}}})}var e,i,o;return e=t,(i=[{key:"cast",value:function(t,e){var i=Math.cos(e),o=Math.sin(e),n=[this.endPoint[0]*i-this.endPoint[1]*o,this.endPoint[0]*o+this.endPoint[1]*i];this.ray.from=t,this.ray.to=[t[0]+n[0],t[1]+n[1]],this.calculateShortest()}},{key:"calculateShortest",value:function(){this.shortest={distance:1/0},this.ray.update(),this.world.raycast(this.result,this.ray),this.result.reset()}}])&&l(e.prototype,i),o&&l(e,o),t}();function v(t,e,i,n,s){var r=new o.Graphics;return r.beginFill(s,1),r.drawRect(t,e,i,n),r.position.set(t,e),r}var g=function(t,e,i,o,s){var a=new n.Entity;a.addComponent(new u([v(0,0,i,o,65280)]));var c=new r.Body({mass:0,position:[t,e]});return c.addShape(new r.Box({width:i,height:o})),a.addComponent(new d(c)),s.addEntity(a),a};function y(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var m=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),i(4)(e instanceof Array),this.bodies=e,this.bodies.forEach(function(t){t.oldOrigin=t.body.position.slice(0)})}var e,o,n;return e=t,(o=[{key:"move",value:function(t,e){this.bodies.forEach(function(i){i.body.position[0]+=t,i.body.position[1]+=e})}},{key:"moveAbsolute",value:function(t,e){this.bodies.forEach(function(t){t.body.position=t.oldOrigin.slice(0)}),this.move(t,e)}}])&&y(e.prototype,o),n&&y(e,n),t}(),w=function(t,e,i,o){var n=o.map(function(t){return t.getComponent("physics")});return new m(n)},b=i(3),P=i.n(b);function C(t,e){for(var i=[],o=0;o<5;o++)i.push(w(0,0,e,t.map(function(t){var i=t.slice(0);return i.push(e),g.apply(null,i)})));return i}var I=n.System.extend({getRoomID:function(){return this.position[0]+","+this.position[1]},setup:function(t,e){var i=this;this.rooms={},this.STARTING_PIECE=e||"I basic",this.world=t,this.rng=new P.a("RNG0,0"),this.position=[0,0],this.parts={"- up":{group:C([[400,250,800,20],[400,550,800,20]],this.world),possibleParts:{left:["upside L"],right:["reverse upside L"]}},"- down":{group:C([[400,250,800,20],[400,550,800,20]],this.world),possibleParts:{left:["L"],right:["reverse L"]}},L:{group:C([[690,250,300,20],[250,160,20,800],[550,50,20,400],[650,550,800,20]],this.world),possibleParts:{up:["I advanced left"],right:["- down"]}},"reverse L":{group:C([[110,250,300,20],[250,0,20,490],[550,0,20,1100],[250,550,620,20]],this.world),possibleParts:{up:["I advanced left"],left:["- down"]}},"upside L":{group:C([[690,550,300,20],[550,740,20,400],[250,640,20,800],[650,250,800,20]],this.world),possibleParts:{down:["I advanced left"],right:["- up"]}},"reverse upside L":{group:C([[110,550,300,20],[250,740,20,400],[550,640,20,800],[150,250,800,20]],this.world),possibleParts:{down:["I advanced right"],left:["- up"]}},"I basic":{group:C([[250,0,20,800],[550,0,20,800]],this.world),possibleParts:{up:["I basic"],down:["I basic"]}},"I with obstructions":{group:C([[250,0,20,800],[550,0,20,800],[300,100,100,20],[500,600,100,20]],this.world),possibleParts:{up:["I with obstructions"],down:["I with obstructions"]}},"I advanced right":{group:C([[250,400,20,800],[550,400,20,800]],this.world),possibleParts:{up:["reverse upside L"],down:["reverse L"]}},"I advanced left":{group:C([[250,400,20,800],[550,400,20,800]],this.world),possibleParts:{up:["upside L"],down:["L"]}}},Object.keys(this.parts).forEach(function(t){i.parts[t].name=t,t!==i.STARTING_PIECE&&i.parts[t].group.forEach(function(t){return t.moveAbsolute(5e4,5e4)})}),this.currentPart=this.parts[this.STARTING_PIECE],this.rooms[this.getRoomID()]={entryPoint:[400,400],distance:0},Object.keys(this.currentPart.possibleParts).forEach(function(t,e){var o=[0,0];"up"===t&&(o[1]+=1),"down"===t&&(o[1]-=1),"left"===t&&(o[0]-=1),"right"===t&&(o[0]+=1);var n=[i.position[0]+o[0],i.position[1]+o[1]],s=new P.a("RNG"+n[0]+","+n[1]).pickone(i.currentPart.possibleParts[t]);i.parts[s].group[e+1].moveAbsolute(800*o[0],800*o[1])})},reset:function(t){var e=this;this.STARTING_PIECE=t||this.STARTING_PIECE,this.rng=new P.a("RNG0,0"),this.position=[0,0],this.rooms={},this.rooms[this.getRoomID()]={entryPoint:[400,400],distance:0},Object.keys(this.parts).forEach(function(t){e.parts[t].group.forEach(function(t){return t.moveAbsolute(5e4,5e4)})}),this.currentPart=this.parts[this.STARTING_PIECE],this.currentPart.group[0].moveAbsolute(0,0),Object.keys(this.currentPart.possibleParts).forEach(function(t,i){var o=[0,0];"up"===t&&(o[1]+=1),"down"===t&&(o[1]-=1),"left"===t&&(o[0]-=1),"right"===t&&(o[0]+=1);var n=[e.position[0]+o[0],e.position[1]+o[1]],s=new P.a("RNG"+n[0]+","+n[1]).pickone(e.currentPart.possibleParts[t]);e.parts[s].group[i+1].moveAbsolute(800*o[0],800*o[1])})},setCar:function(t){this.car=t},getCarPosition:function(){return null!=this.car?this.car.getComponent("physics").body.position:null},swapNextRoadPart:function(t){var e=this;if(void 0!==this.currentPart){var i=this.currentPart.possibleParts[t];0!==i.length&&void 0!==i&&("up"===t&&(this.position[1]+=1),"down"===t&&(this.position[1]-=1),"left"===t&&(this.position[0]-=1),"right"===t&&(this.position[0]+=1),this.currentPart.group.forEach(function(t){return t.moveAbsolute(5e4,5e4)}),this.rng=new P.a("RNG"+this.position[0]+","+this.position[1]),0===this.position[0]&&0===this.position[1]?this.currentPart=this.parts[this.STARTING_PIECE]:this.currentPart=this.parts[this.rng.pickone(i)],this.currentPart.group[0].moveAbsolute(0,0),Object.keys(this.currentPart.possibleParts).forEach(function(t,i){var o=[0,0];"up"===t&&(o[1]+=1),"down"===t&&(o[1]-=1),"left"===t&&(o[0]-=1),"right"===t&&(o[0]+=1);var n=[e.position[0]+o[0],e.position[1]+o[1]],s=new P.a("RNG"+n[0]+","+n[1]).pickone(e.currentPart.possibleParts[t]);e.parts[s].group[i+1].moveAbsolute(800*o[0],800*o[1])}),this.moveCarBackToScreen(t))}},moveCarBackToScreen:function(t){var e=this.car.getComponent("physics").body,i=[0,0];"down"===t?i=[e.position[0],0]:"up"===t?i=[e.position[0],800]:"left"===t?i=[800,e.position[1]]:"right"===t&&(i=[0,e.position[1]]),e.position=i,this.rooms[this.getRoomID()]={entryPoint:e.position.slice(0),distance:0}},switchRoom:function(t){var e=this;this.currentPart.group.forEach(function(t){return t.moveAbsolute(5e4,5e4)}),this.currentPart=this.parts[t],this.parts[t].group[0].moveAbsolute(0,0),Object.keys(this.currentPart.possibleParts).forEach(function(t,i){var o=[0,0];"up"===t&&(o[1]+=1),"down"===t&&(o[1]-=1),"left"===t&&(o[0]-=1),"right"===t&&(o[0]+=1);var n=[e.position[0]+o[0],e.position[1]+o[1]],s=new P.a("RNG"+n[0]+","+n[1]).pickone(e.currentPart.possibleParts[t]);e.parts[s].group[i+1].moveAbsolute(800*o[0],800*o[1])})},update:function(t){var e=this;void 0===this.currentPart&&(this.currentPart=this.parts[this.STARTING_PIECE]);var i=this.getCarPosition();this.rooms[this.getRoomID()].distance=r.vec2.distance(this.rooms[this.getRoomID()].entryPoint,i),this.car.getComponent("car").fitness=0,Object.keys(this.rooms).forEach(function(t){e.car.getComponent("car").fitness+=e.rooms[t].distance});var o,n,s,a=this.car.getComponent("car").options;if(a&&a.player)return this.car.getComponent("car").fitness=a.fitness,void this.switchRoom(a.piece);if(null!==i){var c=(o=i[0],n=i[1],s=800,o>800?"right":n>s?"down":o<0?"left":n<0?"up":"onScreen");"onScreen"!==c&&this.swapNextRoadPart(c)}}});function E(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}i.d(e,"default",function(){return k});var S=i(1);var k=function(){function t(e,i,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.time=e,this.canvasElement=i,this.loader=o}var e,i,c;return e=t,(i=[{key:"init",value:function(t,e){if(void 0===this.world){this.world=new S.World,void 0!==t&&(this.renderer=new s,this.renderer.setCanvas(t),this.renderer.draw=!0,this.world.addSystem(this.renderer)),this.physicsSystem=new a,this.world.addSystem(this.physicsSystem);var i=new h;this.world.addSystem(i),this.car=function(t,e,i,s,a){var c=new n.Entity;if(void 0!==a&&void 0!==a.resources["./static/chassis.png"]){var h=new u([new o.Sprite(a.resources["./static/chassis.png"].texture)]);c.addComponent(h)}var l=new r.Body({mass:2e3,position:[t,e],allowSleep:!1});l.addShape(new r.Box({width:50,height:100})),c.addComponent(new d(l));var v=new r.TopDownVehicle(l),g=v.addWheel({localPosition:[0,50]}),y=v.addWheel({localPosition:[0,-50]});c.addComponent(new p(c,s,v,g,y)),i.addEntity(c);var m=c.getComponent("car"),w=c.getComponent("physics").world;v.addToWorld(w),m.sensors=[];for(var b=210;b<=330;b+=30)m.sensors.push(new f([Math.cos(b*(Math.PI/180)),Math.sin(b*(Math.PI/180))],[l.id],w));return m.sensors.push(new f([Math.cos(Math.PI/180*90),Math.sin(Math.PI/180*90)],[l.id],w)),c}(400,400,this.world,this.genome,this.loader),this.roadDirector=new I,this.roadDirector.setup(this.world,e),this.roadDirector.setCar(this.car),this.world.addSystem(this.roadDirector)}else this.car.getComponent("car").genome=this.genome,this.roadDirector.reset(e);this.lastDt=0}},{key:"evaluate",value:function(t,e,i){this.destroy(),this.genome=t,this.init(this.canvasElement,e),this.acc=0,this.lastDt=null;var o=this;return this.car.getComponent("car").options=i||{},new Promise(function(t){o.onFinish=t})}},{key:"fitness",value:function(){return this.car.getComponent("car").fitness}},{key:"currentPart",value:function(){return this.roadDirector.currentPart.name}},{key:"isRunning",value:function(){return this.acc<this.time&&this.car.getComponent("physics").body.sleepState!==r.Body.SLEEPING}},{key:"evalGenome",value:function(t,e,i){for(this.evaluate(e,i);this.isRunning();)this.update(t);return this.car.getComponent("car").fitness}},{key:"update",value:function(t){null===this.lastDt&&(this.lastDt=t),this.acc+=t;var e=this.car.getComponent("car").fitness;this.isRunning()?this.world.update(t):this.onFinish(e)}},{key:"destroy",value:function(){if(void 0!==this.world){this.car.getComponent("car").fitness=0,this.car.getComponent("car").frontWheel.steerValue=0;var t=this.car.getComponent("physics").body;!function(t,e){var i,o=Object.keys(t);for(var n in o)if("number"==typeof t[o[n]]&&isNaN(t[o[n]]))t[o[n]]=e;else if(null!==t[o[n]]&&t[o[n]].constructor===Float32Array)for(var s=0;s<t[o[n]].length;s++)t[o[n]][s]=(i=t[o[n]][s],isNaN(i)?e:i)}(t,0),t.allowSleep=!1,t.sleepState===r.Body.SLEEPING&&t.wakeUp(),t.setZeroForce(),t.position=[this.position[0],this.position[1]],t.angularVelocity=0,t.velocity=[0,0],t.angle=0,this.roadDirector.reset()}else this.position=[400,400],this.velocity=[0,0]}}])&&E(e.prototype,i),c&&E(e,c),t}()}])});